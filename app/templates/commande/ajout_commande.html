<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajout de Commande</title>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            max-width: 600px; /* Limite la largeur de la carte */
            margin: auto; /* Centre la carte horizontalement */
        }
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 16px rgba(0, 0, 0, 0.2);
        }
        .card-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        form {
            width: 100%;
            padding: 20px;
            border-radius: 10px;
            background-color: #fff;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input[type="number"], input[type="submit"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input[type="submit"] {
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
    <!-- Assurez-vous d'avoir jQuery inclus dans votre template -->
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if messages %}
                        <ul class="messages">
                            {% for message in messages %}
                                <div class="alert alert-danger"{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="form-group">
                        <label for="id_client">Client :</label>
                        {{ form.client }}
                    </div>
                    <div class="form-group">
                        <label for="id_status">Status :</label>
                        {{ form.status }}
                    </div>
                    <div class="form-group">
                        <label for="id_produits">Produits :</label>
                        <select multiple name="produits" id="id_produits">
                            {% for produit in form.fields.produits.queryset %}
                                <option value="{{ produit.id }}" data-prix="{{ produit.prix }}">
                                    {{ produit.nom }} - {{ produit.quantite_en_stock }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="quantites-container">
                        <!-- Les champs de quantité seront insérés ici -->
                    </div>
                    <div class="form-group">
                        Prix Total: <span id="prix_total">0</span>€
                    </div>
                    <input type="submit" value="Ajouter Commande" class="btn">
                </form>
                <!-- Formulaire pour ajouter quantité supplémentaire -->
                {% for produit in form.fields.produits.queryset %}
                    {% if produit.quantite_en_stock < 0 %}
                        <div class="form-group">
                            <form method="post" action="{% url 'augmenter_quantite' produit.id %}">
                                {% csrf_token %}
                                <label for="id_quantite">Quantité supplémentaire pour {{ produit.nom }}:</label>
                                <input type="number" name="quantite" id="id_quantite" min="0" value="0">
                                <input type="submit" value="Ajouter">
                            </form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function(){
            $('#id_produits').change(function(){
                $('#quantites-container').empty();  // Vider le conteneur
                $('#id_produits option:selected').each(function(){
                    var produitId = $(this).val();
                    var produitNom = $(this).text();
                    var produitPrix = $(this).data('prix');  // Récupérer le prix du produit
                    // Ajouter le champ de quantité pour le produit sélectionné
                    $('#quantites-container').append(
                        `<div class="produit-item form-group" data-id="${produitId}" data-prix="${produitPrix}">` +
                        `<label for="quantite_${produitId}">Quantité pour ${produitNom}:</label>` +
                        `<input type="number" name="quantite_${produitId}" id="quantite_${produitId}" value="0" min="0" class="quantite-input form-control">` +
                        `Prix: <span id="prix_${produitId}">${produitPrix}</span>€` +
                        `</div>`
                    );
                });
                updateTotalPrice();  // Mettre à jour le prix total
            });

            // Fonction pour mettre à jour le prix total
            function updateTotalPrice() {
                var total = 0;
                $('.produit-item').each(function() {
                    var id = $(this).data('id');
                    var quantite = parseInt($('#quantite_' + id).val());
                    var prix = $(this).data('prix');
                    var subtotal = quantite * prix;
                    total += subtotal;
                });
                $('#prix_total').text(total.toFixed(2));
            }

            // Événement pour recalculer le prix lorsque la quantité change
            $(document).on('change', '.quantite-input', function() {
                updateTotalPrice();
            });
        });
    </script>
</body>
</html>
